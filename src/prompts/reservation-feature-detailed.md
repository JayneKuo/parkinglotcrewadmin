## **1. 功能模块概览**

1. **预约列表展示与实时状态管理**
2. **预约状态分类及对应操作**
3. **弹窗表单字段及交互逻辑**
4. **操作校验规则与异常处理**

---

## **2. 预约状态分类及对应操作**

### **2.1 状态说明**

- **Pending Payment**: 用户已预定车位，但未完成支付。
  - **触发条件**: 用户成功预定车位，但尚未支付。
  - **可操作内容**: 
    - 用户完成支付后，状态转为 AwaitingUse。
    - 管理员查看订单详情并提醒用户支付，或发起收款。
    - 支付失败或超时未支付，状态转为 Payment Failed 或 Cancelled。

- **Payment Failed**: 用户支付过程中发生错误或未完成支付。
  - **触发条件**: 支付失败，支付未完成。
  - **可操作内容**: 
    - 系统提示用户支付失败。
    - 用户重新支付后，状态转为 AwaitingUse。
    - 管理员查看订单详情并提醒用户支付，或发起收款。
    - 若支付失败且超时，状态转为 Cancelled。

- **AwaitingUse**: 支付成功，等待用户进场停车或系统分配车位。
  - **触发条件**: 用户完成支付，系统确认支付，等待用户进场。
  - **可操作内容**: 
    - 用户可以在有效期内进场停车。
    - 用户未按时进场，超过有效期，状态转为 Expired。
    - 用户或商户操作 check-in 状态转为 In Use。
    - 用户或商户可发起退款。

- **In Use**: 用户已进入停车场，正在使用车位。
  - **触发条件**: 用户进场后，开始使用车位。
  - **可操作内容**: 
    - 用户或商户操作 checkout，离场时判断是否超时。
    - 停车时长计算，用户完成停车，状态转为 Used。

- **Used**: 用户停车完成，且已达到预定时间，停车结束。
  - **触发条件**: 停车完成，停车时长到期。
  - **可操作内容**: 
    - 商户可发起退款。
    - 24小时后更新为 Completed。

- **Cancelled**: 用户或管理员取消订单。
  - **触发条件**: 用户或管理员主动取消订单。
  - **可操作内容**: 
    - 如果订单未支付，状态转为 Cancelled。
    - 如果已支付，可能需要退款，状态转为 Refunded。

- **Refunded**: 用户请求退款或管理员处理退款成功。
  - **触发条件**: 用户请求退款或管理员审核并处理退款。
  - **可操作内容**: 
    - 退款成功后，状态更新为 Refunded。
    - 若退款失败，状态转为 Refund Failed。

- **Expired**: 订单未在有效期内完成支付或未进场停车。
  - **触发条件**: 用户未支付或未进场停车，导致订单过期。
  - **可操作内容**: 
    - 用户未进场，订单过期。系统将订单状态更新为 Expired。

- **Refund Failed**: 退款请求失败，无法完成退款。
  - **触发条件**: 退款请求处理失败，支付渠道或退款系统问题。
  - **可操作内容**: 
    - 系统提示退款失败。
    - 用户可以选择重新申请退款。

- **Refund Requested**: 用户请求退款，等待管理员处理。
  - **触发条件**: 用户因未使用或其他原因发起退款请求。
  - **可操作内容**: 
    - 用户或管理员发起退款，管理员审核退款请求。
    - 退款审核通过后，状态转为 Processing Refund。

- **Processing Refund**: 退款处理中，管理员已批准退款请求。
  - **触发条件**: 管理员批准退款请求，系统开始处理退款。
  - **可操作内容**: 
    - 系统处理中退款，状态更新为 Processing Refund。
    - 退款完成后，状态更新为 Refunded。

- **Overdue**: 停放超时。
  - **触发条件**: 用户离场时间大于约定时间时则会产生超时费用。
  - **可操作内容**: 
    - 用户需支付滞纳金。

---

## **3. 弹窗表单字段及交互逻辑**

### **3.1 确认支付（Confirm Payment）**

- **字段**:
  - 支付方式选择（二维码支付、现金支付、短信链接支付、无需支付）
  - 订单号
  - 支付金额

- **支付方式交互逻辑**:

  1. **二维码支付**:
     - **字段**: 二维码图片展示区域
     - **交互流程**:
       1. 选择二维码支付方式
       2. 订单信息下方展示支付二维码
       3. 用户扫码支付
       4. 系统自动检测支付状态,未支付前确认按钮不可点击。
       5. 支付成功 → 状态更新为"AwaitingUse"
       6. 支付失败 → 提示"支付失败，请重试"
     - **提示**:
       - **中文**: "请使用手机扫描二维码完成支付"
       - **英文**: "Please scan the QR code to complete payment"

  2. **现金支付**:
     - **字段**:
       - 应收金额
       - 实收金额
       - 找零金额
     - **交互流程**:
       1. 选择现金支付方式
       2. 订单信息上方展示输入框，输入实收金额，并确定未输入前，确认按钮不可点击。
       3. 系统自动计算找零，并更新订单信息。
       4. 确认收款 → 状态更新为"AwaitingUse"
     - **提示**:
       - **中文**: "请输入实收金额，系统将自动计算找零"
       - **英文**: "Please enter the received amount, system will calculate change"

  3. **短信链接支付**:
     - **字段**:
       - 手机号（默认显示订单预留手机号）
     - **交互流程**:
       1. 选择短信链接支付
       2. 订单信息上方展示确认/修改手机号按钮，默认填充订单手机号，并未输入前，确认按钮不可点击。
       3. 点击确认按钮，发送支付链接。
       4. 用户通过链接完成支付
       5. 支付成功 → 状态更新为"AwaitingUse"
     - **提示**:
       - **中文**: "支付链接将发送至该手机号，请确认号码无误"
       - **英文**: "Payment link will be sent to this phone number, please confirm"

  4. **无需支付**:
     - **交互流程**:
       1. 选择无需支付
       2. 点击确认
       3. 系统记录支付方式为"无需支付"
       4. 状态直接更新为"AwaitingUse"
     - **提示**:
       - **中文**: "确认标记为无需支付？"
       - **英文**: "Confirm to mark as no payment required?"

- **通用提示**:
  - **中文**: 
    - 成功: "支付成功"
    - 失败: "支付失败，请重试"
  - **英文**: 
    - 成功: "Payment successful"
    - 失败: "Payment failed, please try again"

### **3.2 取消预约（Cancel）**

- **字段**: 无
- **交互逻辑**:
  1. 点击“取消”。
  2. 弹出确认取消对话框。
  3. 用户确认取消。
  4. 系统更新状态为“Cancelled”。

- **提示**:
  - **中文**：“您确定要取消此预约吗？”
  - **英文**：“Are you sure you want to cancel this reservation?”

### **3.3 重试支付（Retry Payment）**

- **字段**:
  - 支付方式选择（信用卡、PayPal等）
- **交互逻辑**:
  1. 点击“重试支付”。
  2. 弹出支付方式选择对话框。
  3. 用户选择支付方式并确认。
  4. 系统处理支付。
  5. 支付成功 → 状态更新为“AwaitingUse”。
  6. 支付失败 → 提示支付失败。

- **提示**:
  - **中文**：“请选择支付方式以重试支付。”
  - **英文**：“Please select a payment method to retry the payment.”

### **3.4 进场（Check In）**

- **字段**: 无
- **交互逻辑**:
  1. 点击“进场”。
  2. 弹出确认进场对话框。
  3. 用户确认进场。
  4. 系统更新状态为“In Use”。

- **提示**:
  - **中文**：“请确认您已到达停车场。”
  - **英文**：“Please confirm you have arrived at the parking lot.”

### **3.5 离场（Check Out）**

- **字段**:
  - 超时费用确认
- **交互逻辑**:
  1. 点击“离场”。
  2. 弹出超时费用确认对话框。
  3. 用户确认支付超时费用。
  4. 系统处理支付。
  5. 支付成功 → 状态更新为“Used”。
  6. 未支付 → 提示后续处理。

- **提示**:
  - **中文**：“请确认支付超时费用以完成离场。”
  - **英文**：“Please confirm payment of overdue fees to complete check-out.”

### **3.6 申请退款（Request Refund）**

- **字段**:
  - 退款原因
- **交互逻辑**:
  1. 点击“申请退款”。
  2. 弹出退款申请对话框。
  3. 用户填写退款原因并提交。
  4. 系统处理退款请求。

- **提示**:
  - **中文**：“请填写退款原因并提交申请。”
  - **英文**：“Please fill in the reason for the refund and submit your request.”

### **3.7 重试退款（Retry Refund）**

- **字段**: 无
- **交互逻辑**:
  1. 点击“重试退款”。
  2. 系统再次尝试处理退款。

- **提示**:
  - **中文**：“正在重试退款，请稍候。”
  - **英文**：“Retrying refund, please wait.”

---

## **4. 操作校验规则与异常处理**

1. **状态校验**：确保操作在正确的状态下执行。
2. **输入校验**：确保所有必填字段填写完整且格式正确。
3. **异常处理**：
   - 数据加载失败 → 提示重试。
   - 网络异常 → 提示检查网络连接。
   - 操作失败 → 提示稍后重试。

- **通用提示**:
  - **中文**：“操作失败，请稍后重试。”
  - **英文**：“Operation failed. Please try again later.”

---
